name: CI Pipeline - Trabajo2HM

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]

jobs:
  test:
    name: Run Tests on Node.js ${{ matrix.node-version }}
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Instalar dependencias
      run: npm ci
      
    - name: Ejecutar pruebas unitarias
      run: npm test
      
    - name: Ejecutar pruebas con cobertura
      run: npm run test:coverage
      
    - name: Subir reporte de cobertura a Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: trabajo2hm-coverage
        
    - name: Verificar cobertura mÃ­nima (80%)
      run: |
        if [ -f "./coverage/coverage-summary.json" ]; then
          COVERAGE=$(node -e "console.log(require('./coverage/coverage-summary.json').total.lines.pct)")
          echo "ğŸ“Š Cobertura de cÃ³digo: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âŒ Cobertura insuficiente: $COVERAGE% (mÃ­nimo requerido: 80%)"
            exit 1
          else
            echo "âœ… Cobertura adecuada: $COVERAGE%"
          fi
        else
          echo "âš ï¸  No se encontrÃ³ reporte de cobertura"
        fi

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: Instalar dependencias
      run: npm ci
        
    - name: AuditorÃ­a de seguridad npm
      run: npm audit --audit-level high
      
    - name: Ejecutar scan de vulnerabilidades
      run: |
        npm audit --json > audit-report.json || true
        echo "ğŸ”’ AuditorÃ­a de seguridad completada"

  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [test, security]
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: Instalar dependencias
      run: npm ci
      
    - name: Verificar que la aplicaciÃ³n construye correctamente
      run: |
        echo "ğŸ”¨ Verificando build..."
        node -e "console.log('âœ… Node.js funciona correctamente')"
        
    - name: Ejecutar la aplicaciÃ³n
      run: |
        echo "ğŸš€ Ejecutando aplicaciÃ³n..."
        npm start
        echo "âœ… AplicaciÃ³n ejecutada exitosamente"
        
    - name: Crear artifact de build
      uses: actions/upload-artifact@v4
      with:
        name: trabajo2hm-build
        path: |
          *.js
          package.json
          package-lock.json
        retention-days: 7

  deploy-demo:
    name: Deploy to Demo Environment
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: Instalar dependencias
      run: npm ci
      
    - name: Ejecutar pruebas finales
      run: npm test
      
    - name: Deploy simulado
      run: |
        echo "ğŸš€ Iniciando despliegue a ambiente demo..."
        echo "ğŸ“¦ VersiÃ³n: $(node -e "console.log(require('./package.json').version)")"
        echo "ğŸ·ï¸  Commit: ${{ github.sha }}"
        echo "âœ… Despliegue demo completado exitosamente"
        
    - name: NotificaciÃ³n de Ã©xito
      run: |
        echo "ğŸ‰ Pipeline CI completado exitosamente!"
        echo "ğŸ“Š Reportes disponibles en la secciÃ³n de artifacts"